<mxfile host="" modified="2021-02-26T03:14:49.296Z" agent="5.0 (Macintosh; Intel Mac OS X 10_16_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36" etag="hoj9L5ZJYePL2OO03AIo" version="13.7.9" type="embed"><diagram id="YXvyjFkgTotu7tPlVu3F" name="TX"><mxGraphModel dx="1774" dy="1888" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0"><root><mxCell id="vNIrbcdj6Tb2kEkjcBfy-0"/><mxCell id="vNIrbcdj6Tb2kEkjcBfy-1" parent="vNIrbcdj6Tb2kEkjcBfy-0"/><mxCell id="pYf-0QWCblDYZuOl6HBY-67" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-62" target="pYf-0QWCblDYZuOl6HBY-11" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-69" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-62" target="pYf-0QWCblDYZuOl6HBY-9" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-88" value="getSynchronizations" style="edgeLabel;align=center;verticalAlign=middle;resizable=0;points=[];" parent="pYf-0QWCblDYZuOl6HBY-69" vertex="1" connectable="0"><mxGeometry x="0.26" y="2" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-74" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-71" target="pYf-0QWCblDYZuOl6HBY-11" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-77" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-75" target="pYf-0QWCblDYZuOl6HBY-71" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-85" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-84" target="pYf-0QWCblDYZuOl6HBY-7" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-86" value="通过  TransactionSynchronizationManager 来保证与事务关联" style="edgeLabel;align=center;verticalAlign=middle;resizable=0;points=[];" parent="pYf-0QWCblDYZuOl6HBY-85" vertex="1" connectable="0"><mxGeometry x="-0.0538" y="1" relative="1" as="geometry"><mxPoint as="offset"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-5" value="[JDBC] DataSourceUtils" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="-125" y="-330" width="370" height="310" as="geometry"><mxRectangle x="-125" y="-330" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-6" value="getConnection(DataSource)&#10;1.  会根据数据源从 TransactionSynchronizationManager 获取绑定的 ConnectionHolder，这样保证同一个事务的内获取的链接是一样的，而不会重新重现链接开启新的事务&#10;2.  如果没有，则从 DataSource 创建获取&#10;3.  如果有事务，注册内部事务同步器 ConnectionSynchronization" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-5" vertex="1"><mxGeometry y="26" width="370" height="94" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-70" value="prepareConnectionForTransaction(con,txDefinition)&#10;根据事务配置，设置原生 connection 是否只读、隔离级别 " style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="pYf-0QWCblDYZuOl6HBY-5" vertex="1"><mxGeometry y="120" width="370" height="44" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-82" value="resetConnectionAfterTransaction(con,IsolationLevel,resetReadOnly)&#10;还原 原始connection 的 prepareConnectionForTransaction 设置" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#d5e8d4;strokeColor=#82b366;" parent="pYf-0QWCblDYZuOl6HBY-5" vertex="1"><mxGeometry y="164" width="370" height="44" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-83" value="isConnectionTransactional(Connection, DataSource)&#10;判断当前链接是否受事务管理： 当前链接是否由事务管理器创建" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-5" vertex="1"><mxGeometry y="208" width="370" height="44" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-84" value="releaseConnection(Connection, DataSource)&#10;1. 获取事务绑定的 ConnectionHolder，释放&#10;2. 如果获取不到，调用 doCloseConnection 关闭原始 Connection" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#fff2cc;strokeColor=#d6b656;" parent="pYf-0QWCblDYZuOl6HBY-5" vertex="1"><mxGeometry y="252" width="370" height="58" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-7" value="[TX] TransactionSynchronizationManager" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=30;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="-120" y="60" width="360" height="310" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-8" value="&lt;Map&lt;Object, Object&gt;&gt; resources&#10;&lt;Set&lt;TransactionSynchronization&gt;&gt; synchronizations&#10;&#10;&lt;String&gt; currentTransactionName&#10;&lt;Boolean&gt; currentTransactionReadOnly&#10;&lt;Integer&gt; currentTransactionIsolationLevel&#10;&lt;Boolean&gt; actualTransactionActive" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" parent="pYf-0QWCblDYZuOl6HBY-7" vertex="1"><mxGeometry y="30" width="360" height="110" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-63" value="bindResource(key, value)                绑定资源&#10;     datasource - connectionHolder&#10;     sessionFactory - sqlSession&#10;getResource(key)                            获取资源&#10;getResourceMap()                          当前线程所有的绑定(resources)&#10;unbindResource(key)                      解绑资源" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;fillColor=#a20025;strokeColor=#6F0000;fontColor=#ffffff;" parent="pYf-0QWCblDYZuOl6HBY-7" vertex="1"><mxGeometry y="140" width="360" height="100" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-62" value="initSynchronization          初始化使用同步器&#10;registerSynchronization   &lt;-&gt; synchronizations 注册事务回调&#10;getSynchronizations        获取 注册的 synchronizations 集合&#10;clearSynchronization       清空 注册的 synchronizations 集合" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;fillColor=#647687;strokeColor=#314354;fontColor=#ffffff;" parent="pYf-0QWCblDYZuOl6HBY-7" vertex="1"><mxGeometry y="240" width="360" height="70" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-90" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-15" target="pYf-0QWCblDYZuOl6HBY-13" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-91" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-17" target="pYf-0QWCblDYZuOl6HBY-13" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-9" value="[TX] TransactionSynchronizationUtils&#10;触发 registerSynchronization 注册的回调" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;fillColor=#647687;strokeColor=#314354;fontColor=#ffffff;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="150" y="430" width="250" height="84" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-10" value="trigger*： &#10;触发注册的 TransactionSynchronization 回调" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-9" vertex="1"><mxGeometry y="40" width="250" height="44" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-11" value="[TX] TransactionSynchronization&#10;用于注册 “事务回调”" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;fillColor=#647687;strokeColor=#314354;fontColor=#ffffff;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="-290" y="430" width="350" height="250" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-12" value="suspend 暂停事务：解绑资源，记录当前事务状态后清空" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" parent="pYf-0QWCblDYZuOl6HBY-11" vertex="1"><mxGeometry y="40" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-56" value="resume 恢复事务： 绑定资源，根据 suspend 返回 Holder 恢复" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" parent="pYf-0QWCblDYZuOl6HBY-11" vertex="1"><mxGeometry y="70" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-57" value="flush" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-11" vertex="1"><mxGeometry y="100" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-58" value="beforeCommit(readOnly)" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-11" vertex="1"><mxGeometry y="130" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-59" value="beforeCompletion" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-11" vertex="1"><mxGeometry y="160" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-60" value="afterCommit" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-11" vertex="1"><mxGeometry y="190" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-61" value="afterCompletion" style="rounded=0;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;whiteSpace=wrap;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="pYf-0QWCblDYZuOl6HBY-11" vertex="1"><mxGeometry y="220" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-75" value="ConnectionSynchronization&#10;清理非本地事务的资源" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="-408" y="832" width="250" height="60" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-78" value="" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-75" vertex="1"><mxGeometry y="40" width="250" height="20" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-71" value="TransactionSynchronizationAdapter" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="-285" y="710" width="250" height="60" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-72" value="" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-71" vertex="1"><mxGeometry y="40" width="250" height="20" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-92" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-24" target="pYf-0QWCblDYZuOl6HBY-17" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-93" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-31" target="pYf-0QWCblDYZuOl6HBY-24" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-97" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.25;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-31" target="pYf-0QWCblDYZuOl6HBY-94" edge="1"><mxGeometry relative="1" as="geometry"><Array as="points"><mxPoint x="892" y="-80"/><mxPoint x="645" y="-80"/></Array></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-98" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.25;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-94" target="pYf-0QWCblDYZuOl6HBY-17" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-13" value="[TX] TransactionManager&#10;空的标记接口" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="664" y="-660" width="250" height="50" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-14" value="" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-13" vertex="1"><mxGeometry y="40" width="250" height="10" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-15" value="[TX] ReactiveTransactionManager&#10;Reactive 事务支持" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="534" y="-560" width="250" height="50" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-89" value="" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-15" vertex="1"><mxGeometry y="40" width="250" height="10" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-17" value="[TX] PlatformTransactionManager&#10;平台事务管理器" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="824" y="-560" width="310" height="130" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-18" value="- TransactionStatus getTransaction(TransactionDefinition)" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-17" vertex="1"><mxGeometry y="40" width="310" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-22" value="- commit(TransactionStatus)" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-17" vertex="1"><mxGeometry y="70" width="310" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-23" value="- rollback(TransactionStatus)" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-17" vertex="1"><mxGeometry y="100" width="310" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-106" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-100" target="pYf-0QWCblDYZuOl6HBY-102" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-24" value="[TX] AbstractPlatformTransactionManager&#10;【模板类】事务核心实现" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;fillColor=#f0a30a;strokeColor=#BD7000;fontColor=#ffffff;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="794" y="-389.5" width="370" height="290" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-100" value="- TransactionStatus getTransaction(TransactionDefinition)&#10;1. doGetTransaction 获取 事务对象 Object，具体类型由子类定义&#10;2. 处理事务的传播机 (handleExistingTransaction)" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" parent="pYf-0QWCblDYZuOl6HBY-24" vertex="1"><mxGeometry y="40" width="370" height="60" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-107" value="- commit(TransactionStatus)&#10;1. 如果 LocalRollbackOnly 状态被标记为 rollback 则进行回滚操作&#10;2. 如果 GlobalRollbackOnly 状态被标记为 rollback 则进行回滚操作&#10;3. 进行提交操作&#10;3.1  如果有 SavePoint 则进行撤销&#10;3.2  对嵌套事务的处理" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-24" vertex="1"><mxGeometry y="100" width="370" height="100" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-114" value="- rollback(TransactionStatus)&#10;1. 如果有检查点，回滚到检查点&#10;2. 执行回滚" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-24" vertex="1"><mxGeometry y="200" width="370" height="50" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-25" value="模板方法：【doGetTransaction】【doBegin】&#10;【doCommit】【doRollback】" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-24" vertex="1"><mxGeometry y="250" width="370" height="40" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-99" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" parent="pYf-0QWCblDYZuOl6HBY-24" source="pYf-0QWCblDYZuOl6HBY-25" target="pYf-0QWCblDYZuOl6HBY-25" edge="1"><mxGeometry relative="1" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-31" value="[JDBC] DataSourceTransactionManager&#10;JDBC 事务" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;fillColor=#fa6800;strokeColor=#C73500;fontColor=#ffffff;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="804" y="-20" width="350" height="210" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-32" value="- doGetTransaction 获取事务对象，保存事务的元数据信息" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-31" vertex="1"><mxGeometry y="40" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-33" value="- doBegin  &#10;1. 从关联的 DataSource 中获取 Connection，与事务对象关联&#10;2. 设置 conn 的 隔离级别、只读、关闭自动提交、超时&#10;3. TransactionSynchronizationManager.bindResource 绑定 DataSoure 和 ConnectionHolder" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-31" vertex="1"><mxGeometry y="70" width="350" height="80" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-47" value="- doCommit" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-31" vertex="1"><mxGeometry y="150" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-48" value="- doRollback" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-31" vertex="1"><mxGeometry y="180" width="350" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-101" value="TransactionDefinition&#10;事务的元数据定义" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="1230" y="-540" width="550" height="294" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-102" value="【传播机制】AbstractPlatformTransactionManager.getTransaction&#10;------------------------------------------------------------ handleExistingTransaction 有事务的时候，处理完返回&#10;【NEVER】，不支持事务，如果有抛出异常&#10;【NOT_SUPPORTED】，不支持事务，如果有 suspend，并标记事务状态&#10;&#10;【REQUIRES_NEW】suspend 当前事务，开启新的事务（获取新的 Conn 并开启事务）&#10;【NESTED】嵌套事务，本地事务 JDBC SavePoint，JTA 创建新事务 嵌套 begin/commit/rollback&#10;------------------------------------------------------------ 没有事务的事务&#10;【MANDATORY】没有事务，抛出异常&#10;【REQUIRED】【REQUIRES_NEW】【NESTED】开启新的事务&#10;【SUPPORTS】什么也不做" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;fillColor=#d5e8d4;strokeColor=#82b366;" parent="pYf-0QWCblDYZuOl6HBY-101" vertex="1"><mxGeometry y="40" width="550" height="170" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-103" value="【隔离级别】最终传递给 原始 connection" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-101" vertex="1"><mxGeometry y="210" width="550" height="26" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-105" value="【是否只读】最终传递给 原始 connection" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-101" vertex="1"><mxGeometry y="236" width="550" height="28" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-104" value="【超时时间】" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-101" vertex="1"><mxGeometry y="264" width="550" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-94" value="[TX] ResourceTransactionManager&#10;" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="530" y="-389.5" width="230" height="120" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-95" value="DataSourceTransactionManager 实现&#10;获取原始数据源&#10;public Object getResourceFactory() {&#10; return obtainDataSource();&#10;}" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-94" vertex="1"><mxGeometry y="40" width="230" height="80" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-54" value="&lt;&lt;abstract&gt;&gt; TransactionAspectSupport&#10;AOP 事务模版" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="650" y="470" width="290" height="84" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-55" value="invokeWithinTransaction 定义了事务的执行流程&#10;getTransaction / commit / rollback" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-54" vertex="1"><mxGeometry y="40" width="290" height="44" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-117" value="" style="endArrow=block;endSize=16;endFill=0;html=1;edgeStyle=orthogonalEdgeStyle;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" source="pYf-0QWCblDYZuOl6HBY-115" target="pYf-0QWCblDYZuOl6HBY-55" edge="1"><mxGeometry x="585" y="260" width="160" as="geometry"><mxPoint x="890" y="550" as="sourcePoint"/><mxPoint x="1007.5" y="410" as="targetPoint"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-115" value="TransactionInterceptor&#10;AOP 的 Advice 通知增强" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="670" y="600" width="250" height="70" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-116" value="核心逻辑的调用 父类 invokeWithinTransaction" style="rounded=0;whiteSpace=wrap;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-115" vertex="1"><mxGeometry y="40" width="250" height="30" as="geometry"/></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-52" value="TransactionTemplate&#10;编程式事务" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=40;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;rounded=1;shadow=0;glass=0;sketch=0;html=0;" parent="vNIrbcdj6Tb2kEkjcBfy-1" vertex="1"><mxGeometry x="1220" y="470" width="250" height="84" as="geometry"><mxRectangle x="200" y="1001" width="260" height="26" as="alternateBounds"/></mxGeometry></mxCell><mxCell id="pYf-0QWCblDYZuOl6HBY-53" value="" style="rounded=0;whiteSpace=wrap;html=1;shadow=0;glass=0;sketch=0;align=left;verticalAlign=top;" parent="pYf-0QWCblDYZuOl6HBY-52" vertex="1"><mxGeometry y="40" width="250" height="44" as="geometry"/></mxCell></root></mxGraphModel></diagram></mxfile>